<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RC CAR SOLAR 24/7 – QUANG328P</title>
<style>
body{margin:0;background:#0b0b0b;color:#00ff88;font-family:monospace;text-align:center;}
.section{border:1px solid #00ff88;margin:8px;padding:6px;border-radius:6px;}
.row{display:flex;justify-content:space-between;margin:4px 0;align-items:center;}
button{width:60px;height:48px;margin:2px;font-size:18px;font-weight:bold;background:#111;color:#00ff88;border:2px solid #00ff88;border-radius:6px;}
button:active{background:#00ff88;color:#000;}
input[type=range]{width:80px;}
.small{font-size:12px;}
.charging { color: #ff4444; font-weight:bold; }
.normal   { color: #00ff88; }
.gpio-on  { background:#ff4444; color:#000; }
.gpio-off { background:#111; color:#00ff88; }
.motor-row { justify-content:center; align-items:center; margin:2px 0; }
</style>
</head>
<body>

<h2>RC CAR SOLAR 24/7</h2>
<div class="small">Project by QUANG328P</div>

<!-- POWER -->
<div class="section">
<b>POWER</b>
<div class="row"><span>pin_chính</span><span id="p1" class="normal">-</span></div>
<div class="row"><span>Pin_phụ</span><span id="p2" class="normal">-</span></div>
<div class="row"><span>Pin_motor</span><span id="p3" class="normal">-</span></div>
<div class="row"><span>Nguồn_đan_dùng</span><span id="src">-</span></div>
<div class="row"><span>Sạc_pin</span><span id="chg">-</span></div>
</div>

<!-- SOLAR -->
<div class="section">
<b>SOLAR PANEL</b>
<div class="row"><span>Điện áp</span><span id="solar">-</span></div>
</div>

<!-- MOTOR + TRIM -->
<div class="section">
<b>MOTOR</b>

<!-- TRIM trái -->
<div class="row" style="justify-content:flex-start;align-items:center;">
  <span>TRIM L</span>
  <input type="range" min="-30" max="30" value="0" id="trimL" style="margin-left:5px;">
  <span id="trimLval">0</span>
</div>

<!-- Nút motor -->
<div class="motor-row"><button data-cmd="F">▲</button></div>
<div class="motor-row">
  <button data-cmd="L">◀</button>
  <button id="stopBtn">■</button>
  <button data-cmd="R">▶</button>
</div>
<div class="motor-row"><button data-cmd="B">▼</button></div>

<!-- TRIM phải -->
<div class="row" style="justify-content:flex-end;align-items:center;">
  <span>TRIM R</span>
  <input type="range" min="-30" max="30" value="0" id="trimR" style="margin-left:5px;">
  <span id="trimRval">0</span>
</div>

<div class="row"><span>Trạng thái</span><span id="motor">-</span></div>
<div class="row"><span>ETA</span><span id="eta">-</span></div>
</div>

<!-- SPEED -->
<div class="section">
<b>SPEED (PWM)</b><br>
<input type="range" min="80" max="255" value="180" id="spd">
<div class="small">PWM: <span id="spdVal">180</span></div>
</div>

<!-- GPIO CONTROL -->
<div class="section">
<b>GPIO CONTROL</b>
<div class="row" style="justify-content:center;">
  <button id="gpio0">GPIO0</button>
  <button id="gpio1">GPIO4</button>
  <button id="gpio2">GPIO12</button>
  <button id="gpio3">GPIO13</button>
  <button id="gpio4">GPIO14</button>
</div>
</div>

<div class="section">
<b>WS STATUS</b>: <span id="ws">Đang kết nối...</span>
</div>

<script>
let ws;
let holdTimer=null;
let currentCmd=null;
let spd=180;
let gpioState=[false,false,false,false,false];

function wsConnect(){

  ws = new WebSocket(
    (location.protocol === "https:" ? "wss://" : "ws://")
    + location.host
    + "/ws"
  );

  ws.onopen = ()=>{
    wsStatus("Đã kết nối");
    ws.send(JSON.stringify({hello:1}));
  };

  ws.onclose = ()=>{
    wsStatus("Mất kết nối - đang thử lại...");
    setTimeout(wsConnect, 2000);
  };

  ws.onerror = ()=>{
    wsStatus("Lỗi WebSocket");
  };

  ws.onmessage = e => {

    const j = JSON.parse(e.data);
    const has = v => v !== undefined && v !== null;

    // ===== TELEMETRY =====
    if(has(j.v1) || has(j.v2) || has(j.v3) || has(j.solarV)){

      const fmt = (v,s) =>
        (v/100).toFixed(2)+"V ("+s+"%)";

      if(has(j.v1))
        p1.innerText = fmt(j.v1,j.soc1);

      if(has(j.v2))
        p2.innerText = fmt(j.v2,j.soc2);

      if(has(j.v3))
        p3.innerText = fmt(j.v3,j.soc3);

      if(has(j.solarV))
        solar.innerText = (j.solarV/100).toFixed(2)+"V";

      if(has(j.src1) || has(j.src2)){
        src.innerText = j.src1 ? "Pin chính" :
                        j.src2 ? "Pin phụ" : "-";
      }

      if(has(j.chg1) || has(j.chg2) || has(j.chg3)){
        let c=[];
        if(j.chg1) c.push("P1");
        if(j.chg2) c.push("P2");
        if(j.chg3) c.push("P3");
        chg.innerText = c.length ? c.join(", ") : "Không";
      }
    }

    if(has(j.motor))
      motor.innerText = j.motor ? "ĐANG CHẠY" : "DỪNG";

    if(has(j.speed))
      spdVal.innerText = j.speed;

    if(has(j.trimL))
      trimLval.innerText = j.trimL;

    if(has(j.trimR))
      trimRval.innerText = j.trimR;

    for(let i=0;i<5;i++){
      if(has(j["g"+i])){
        gpioState[i] = j["g"+i] ? true : false;
        let btn = document.getElementById("gpio"+i);
        btn.className = gpioState[i] ? "gpio-on" : "gpio-off";
      }
    }
  };
}

function wsStatus(s){
  document.getElementById("ws").innerText=s;
}


/* MOTOR */
function sendMotor(cmd){
  if(ws && ws.readyState===1){
    let data={cmd:"motor",run:1,dir:cmd,speed:spd,
              trimL:parseInt(trimLSlider.value),trimR:parseInt(trimRSlider.value)};
    ws.send(JSON.stringify(data));
  }
}
function startHold(cmd){
  if(currentCmd===cmd) return;
  currentCmd=cmd;
  sendMotor(cmd);
  clearInterval(holdTimer);
  holdTimer=setInterval(()=>sendMotor(cmd),150);
}
function stopMotor(){
  clearInterval(holdTimer); holdTimer=null; currentCmd=null;
  if(ws && ws.readyState===1) ws.send(JSON.stringify({cmd:"motor",run:0}));
}
document.querySelectorAll("button[data-cmd]").forEach(btn=>{
  const cmd=btn.dataset.cmd;
  btn.addEventListener("pointerdown",e=>{e.preventDefault();startHold(cmd);});
  btn.addEventListener("pointerup",stopMotor);
  btn.addEventListener("pointerleave",stopMotor);
});
document.getElementById("stopBtn").addEventListener("click",stopMotor);

/* SPEED */
const spdSlider=document.getElementById("spd");
const spdVal=document.getElementById("spdVal");
spdSlider.oninput=()=>{
  spd=spdSlider.value;
  spdVal.innerText=spd;
  if(currentCmd) startHold(currentCmd);
};

/* TRIM */
const trimLSlider=document.getElementById("trimL");
const trimRSlider=document.getElementById("trimR");
const trimLval=document.getElementById("trimLval");
const trimRval=document.getElementById("trimRval");
trimLSlider.oninput=()=>{trimLval.innerText=trimLSlider.value;if(currentCmd) startHold(currentCmd);}
trimRSlider.oninput=()=>{trimRval.innerText=trimRSlider.value;if(currentCmd) startHold(currentCmd);}

/* GPIO */
for(let i=0;i<5;i++){
  document.getElementById("gpio"+i).onclick=()=>{
    gpioState[i]=!gpioState[i];
    document.getElementById("gpio"+i).className=gpioState[i]?"gpio-on":"gpio-off";
    if(ws && ws.readyState===1) ws.send(JSON.stringify({cmd:"gpio",num:i,state:gpioState[i]?1:0}));
  }
}

wsConnect();
</script>
</body>
</html>
